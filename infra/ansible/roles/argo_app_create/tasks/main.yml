- name: Check if ArgoCD port-forward is running
  shell: "pgrep -f 'kubectl.*port-forward.*argocd-server.*{{ port_forward_local }}:443'"
  register: port_forward_check
  ignore_errors: yes

- name: Start ArgoCD server port-forward if not running
  shell: "nohup kubectl -n argocd port-forward svc/argocd-server {{ port_forward_local }}:443 >/dev/null 2>&1 &"
  when: port_forward_check.rc != 0
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Wait a moment for port-forward to be ready
  pause:
    seconds: 2

- name: Install required packages
  apt:
    name:
      - jq
      - curl
      - python3-pip
    state: present
    update_cache: yes

- name: Install kubernetes python module
  pip:
    name: kubernetes
    executable: pip3

- name: Ensure admin.conf exists
  stat:
    path: /etc/kubernetes/admin.conf
  register: kubeconfig

- name: Fail if kubeconfig missing
  fail:
    msg: "/etc/kubernetes/admin.conf NOT FOUND"
  when: not kubeconfig.stat.exists

- name: Get ArgoCD admin password from secret
  shell: |
    kubectl -n argocd get secret argocd-initial-admin-secret \
      -o jsonpath="{.data.password}" | base64 -d
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: argocd_admin_password

- name: Login to ArgoCD if not already logged in
  shell: |
    if ! argocd context get {{ ansible_host }}:{{ port_forward_local }} >/dev/null 2>&1; then
      argocd login {{ ansible_host }}:{{ port_forward_local }} \
        --username admin \
        --password "{{ argocd_admin_password.stdout }}" \
        --insecure --grpc-web
    fi
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Register ArgoCD Applications
  loop: "{{ apps }}"
  loop_control:
    loop_var: app
  shell: |
    if argocd app get {{ app.name }} > /dev/null 2>&1; then
      echo "App {{ app.name }} already exists â†’ skip"
    else
      argocd app create {{ app.name }} \
        --repo {{ repo_url }} \
        --path {{ app.path }} \
        --dest-server https://kubernetes.default.svc \
        --dest-namespace {{ app.namespace }} \
        --sync-policy none \
        --sync-option CreateNamespace=true \
        --grpc-web
    fi
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
