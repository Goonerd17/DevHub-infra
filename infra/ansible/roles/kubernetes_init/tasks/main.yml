---
# 1) IPv4 forwarding
- name: Enable IPv4 forwarding
  ansible.builtin.sysctl:
    name: net.ipv4.ip_forward
    value: 1
    state: present
    reload: yes

# 2) kubeadm init
- name: Initialize Kubernetes master
  ansible.builtin.command: >
    kubeadm init
    --pod-network-cidr=192.168.0.0/16
    --apiserver-advertise-address={{ ansible_host }}
  args:
    creates: /etc/kubernetes/admin.conf

# 3) kubeconfig for vagrant
- name: Ensure vagrant .kube directory exists
  ansible.builtin.file:
    path: /home/vagrant/.kube
    state: directory
    owner: vagrant
    group: vagrant

- name: Copy kubeconfig for vagrant
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/vagrant/.kube/config
    owner: vagrant
    group: vagrant
    remote_src: yes

# 4) kubeconfig for root
- name: Ensure root .kube directory exists
  ansible.builtin.file:
    path: /root/.kube
    state: directory

- name: Copy admin kubeconfig to root
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    remote_src: yes

# 5) Always generate fresh join command (정답 방식)
- name: Generate kubeadm join command
  ansible.builtin.command: kubeadm token create --print-join-command
  register: join_cmd

- name: Save join script
  ansible.builtin.copy:
    dest: /tmp/kubeadm_join.sh
    content: |
      #!/bin/bash
      {{ join_cmd.stdout }}
    mode: '0700'

# 6) Calico CNI
- name: Install Calico CNI
  ansible.builtin.command: kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
  environment:
    KUBECONFIG: /root/.kube/config
